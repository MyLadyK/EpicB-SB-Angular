<div class="max-w-4xl mx-auto mt-10 bg-white rounded-lg shadow-lg p-8">
  <h2 class="text-2xl font-bold mb-6 text-blue-900">
    <span>⚔️ Batalla contra {{ opponent?.nameUser || 'Oponente' }} ⚔️</span>
  </h2>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
    <div class="bg-blue-50 rounded-lg p-4 shadow flex flex-col items-center"
         [ngClass]="{
           'ring-4 ring-red-500 animate-pulse': battleInProgress && attackingCharacter === selectedCharacter1,
           'ring-4 ring-blue-500': battleInProgress && defendingCharacter === selectedCharacter1
         }">
      <img *ngIf="getCharacter1()" [src]="getCharacterImageUrl(getCharacter1())" alt="Personaje 1" class="w-24 h-24 object-cover rounded-full border-2 border-blue-300 mb-2"
           [ngClass]="{
             'border-red-500 border-4': battleInProgress && attackingCharacter === selectedCharacter1,
             'border-blue-500 border-4': battleInProgress && defendingCharacter === selectedCharacter1
           }">
      <p class="font-semibold text-blue-800">{{ getCharacterName(getCharacter1()) }}</p>
      <div class="w-full mt-2">
        <div class="h-4 bg-gray-200 rounded-full">
          <div class="h-4 bg-green-500 rounded-full transition-all duration-500" [style.width]="getCharacter1()?.healthUserCharacter || '100%'">
        </div>
        <span class="text-xs text-gray-700">Salud: {{ battleInProgress ? currentHealth1 : getCharacter1()?.healthUserCharacter || 0 }}</span>
      </div>
    </div>
    <div class="bg-blue-50 rounded-lg p-4 shadow flex flex-col items-center"
         [ngClass]="{
           'ring-4 ring-red-500 animate-pulse': battleInProgress && attackingCharacter === selectedCharacter2,
           'ring-4 ring-blue-500': battleInProgress && defendingCharacter === selectedCharacter2
         }">
      <img *ngIf="getCharacter2()" [src]="getCharacterImageUrl(getCharacter2())" alt="Personaje 2" class="w-24 h-24 object-cover rounded-full border-2 border-blue-300 mb-2"
           [ngClass]="{
             'border-red-500 border-4': battleInProgress && attackingCharacter === selectedCharacter2,
             'border-blue-500 border-4': battleInProgress && defendingCharacter === selectedCharacter2
           }">
      <p class="font-semibold text-blue-800">{{ getCharacterName(getCharacter2()) }}</p>
      <div class="w-full mt-2">
        <div class="h-4 bg-gray-200 rounded-full">
          <div class="h-4 bg-green-500 rounded-full transition-all duration-500" [style.width]="getCharacter2()?.healthUserCharacter || '100%'">
        </div>
        <span class="text-xs text-gray-700">Salud: {{ battleInProgress ? currentHealth2 : getCharacter2()?.healthUserCharacter || 0 }}</span>
      </div>
    </div>
  </div>

  <div class="flex justify-center mb-6">
    <button (click)="fight()" [disabled]="loading" class="btn bg-blue-700 text-white font-bold px-6 py-2 rounded shadow hover:bg-blue-900 transition-colors">Iniciar Batalla</button>
  </div>

  <div *ngIf="loading" class="text-center p-4">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-700 mx-auto"></div>
    <p class="mt-2 text-gray-600">Cargando resumen de batalla...</p>
  </div>
  
  <div *ngIf="error" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 my-4 rounded shadow-md">
    <div class="flex items-center">
      <svg class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
      </svg>
      <p>{{ error }}</p>
    </div>
  </div>

  <div *ngIf="battleResult" class="mt-8">
    <h3 class="text-xl font-bold mb-4 text-blue-900">Desarrollo de la Batalla</h3>
    <div class="bg-blue-50 rounded-lg p-4 shadow mb-4">
      <div *ngFor="let event of battleResult.events; let i = index" class="mb-2 text-gray-800"
           [ngClass]="{'font-bold': i === currentEventIndex - 1, 'opacity-50': !eventAnimations[i]}">
        <span [ngClass]="{
          'font-bold text-red-600': event.description?.includes('Golpe crítico'),
          'font-bold text-purple-600': event.description?.includes('Habilidad especial'),
          'font-bold text-green-600': event.description?.includes('Victoria'),
          'animate-pulse': i === currentEventIndex - 1 && battleInProgress
        }">
          {{ event.description || 'Evento de batalla' }}
        </span>
      </div>

      <!-- Mostrar el resultado final solo cuando la batalla ha terminado -->
      <div *ngIf="!battleInProgress && battleResult" class="mt-4 border-t pt-4 border-gray-300">
        <div class="mt-2">
          <span class="font-semibold text-green-700">{{ battleResult?.result || 'Resultado desconocido' }}</span>
        </div>
        
        <!-- Mostrar el paquete sorpresa con animación -->
        <div *ngIf="battleResult.events" class="surprise-banner">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a4 4 0 00-4-4H5.5A2.5 2.5 0 003 4.5v0A2.5 2.5 0 005.5 7H8m4-3h3a4 4 0 014 4v0a4 4 0 01-4 4H8"/>
          </svg>
          <span>¡Paquete Sorpresa Obtenido!</span>
        </div>

        <!-- Mostrar los puntos ganados/perdidos -->
        <div class="points-banner">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
          </svg>
          <span>{{ battleResult.pointsGained > 0 ? '+' + battleResult.pointsGained : battleResult.pointsLost }} puntos de ranking</span>
        </div>

        <div class="mt-2 text-blue-700">
          <span class="font-semibold">Oponente:</span> {{ opponent?.nameUser || 'Oponente desconocido' }}
        </div>
        <div class="mt-2 text-gray-700">
          <span class="font-semibold">Fecha:</span> {{ battleResult?.date || 'Fecha desconocida' }}
        </div>
      </div>
    </div>
  </div>
</div>
